<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Конструктор + Чат с OpenRouter</title>
<style>
  body { background: #0f172a; color: #e2e8f0; font-family: Arial, sans-serif; padding: 20px; max-width: 920px; margin: auto; }
  h1 { color: #a5b4fc; }
  label { display: block; margin: 15px 0 6px; font-weight: bold; }
  input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #1e293b; color: white; border: 1px solid #334155; border-radius: 6px; box-sizing: border-box; }
  textarea { height: 140px; }
  button { padding: 12px 30px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin: 10px 5px 10px 0; }
  button:hover { background: #16a34a; }
  #status { padding: 12px; border-radius: 6px; margin: 10px 0; font-weight: bold; }
  .success { background: #16a34a; color: white; }
  .error   { background: #dc2626; color: white; }
  pre { background: #111; padding: 15px; border-radius: 6px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 13px; }

  /* Чат-окно */
  #chat-container { margin-top: 40px; border-top: 2px solid #334155; padding-top: 20px; }
  #chat-messages { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 15px; height: 300px; overflow-y: auto; margin-bottom: 10px; }
  .message { margin: 10px 0; padding: 10px; border-radius: 8px; }
  .user { background: #2563eb; color: white; text-align: right; margin-left: 30%; }
  .ai   { background: #1e293b; color: white; margin-right: 30%; }
  #chat-input { width: calc(100% - 100px); padding: 10px; background: #1e293b; color: white; border: 1px solid #334155; border-radius: 6px; }
  #send-chat { padding: 10px 20px; background: #3b82f6; }
</style>
</head>
<body>

<h1>Конструктор ботов + Проверка OpenRouter</h1>

<label>GitHub PAT</label>
<input id="token" placeholder="ghp_...">

<label>Имя репозитория</label>
<input id="repo" value="mu-bot-ai">

<label>Telegram Bot Token</label>
<input id="tg" placeholder="123456:AAE...">

<label>OpenRouter API Key</label>
<input id="openrouter" placeholder="sk-or-v1-...">

<label>Описание бота</label>
<textarea id="description">Создай бота для клининга в Уфе с меню кнопок...</textarea>

<button onclick="checkPat()">ПРОВЕРИТЬ PAT</button>
<button onclick="generateAndDeploy()">СОЗДАТЬ БОТА</button>

<div id="status"></div>
<pre id="log">Логи...\n</pre>

<!-- ЧАТ ДЛЯ ТЕСТА OPENROUTER -->
<div id="chat-container">
  <h2>Чат с OpenRouter (проверка ключа)</h2>
  <div id="chat-messages"></div>
  <div>
    <input id="chat-input" placeholder="Напиши сообщение для ИИ (например: 'Привет, тест')">
    <button id="send-chat" onclick="sendChatMessage()">Отправить</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl-util/0.15.1/nacl-util.min.js"></script>

<script>
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');

function log(t) { logEl.textContent += t + '\n'; logEl.scrollTop = logEl.scrollHeight; }

function setStatus(t, type = '') {
  statusEl.textContent = t;
  statusEl.className = 'status ' + type;
}

function addChatMessage(text, isUser = false) {
  const div = document.createElement('div');
  div.className = 'message ' + (isUser ? 'user' : 'ai');
  div.textContent = text;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendChatMessage() {
  const text = chatInput.value.trim();
  if (!text) return;

  addChatMessage(text, true);
  chatInput.value = '';

  const key = document.getElementById('openrouter').value.trim();
  if (!key) {
    addChatMessage('Ошибка: вставь OpenRouter ключ выше', false);
    return;
  }

  addChatMessage('Думаю...', false);

  try {
    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${key}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'openai/gpt-4o-mini',
        messages: [{ role: 'user', content: text }],
        max_tokens: 300,
        temperature: 0.7
      })
    });

    if (!res.ok) {
      const err = await res.text();
      throw new Error(`Ошибка ${res.status}: ${err}`);
    }

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || 'Нет ответа';
    chatMessages.lastChild.textContent = reply;
  } catch (err) {
    chatMessages.lastChild.textContent = 'Ошибка: ' + err.message;
    console.error(err);
  }
}

async function checkPat() {
  // ... (код проверки PAT остаётся прежним, можешь вставить из предыдущей версии)
  // Пока оставим заглушку, чтобы не удлинять
  setStatus('PAT проверка временно отключена', '');
}

// generateAndDeploy — можно оставить прежний, или упростить
async function generateAndDeploy() {
  setStatus('Генерация пока отключена — сначала проверь чат выше', 'error');
  log('Сначала проверь ключ в чате с OpenRouter');
}

// Привязка
window.checkPat = checkPat;
window.generateAndDeploy = generateAndDeploy;
window.sendChatMessage = sendChatMessage;
</script>
</body>
</html>
