<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Telegram AI Bot Stable Installer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl-util/0.15.1/nacl-util.min.js"></script>
<style>
body{background:#0f1115;color:#fff;font-family:monospace;padding:20px}
input{width:100%;margin:5px 0;padding:8px;background:#1a1d24;border:1px solid #333;color:#fff}
button{padding:10px;background:#00ff99;border:none;font-weight:bold;cursor:pointer}
#log{background:#000;padding:10px;height:300px;overflow:auto;margin-top:10px}
</style>
</head>
<body>

<h2>ðŸ”¥ Telegram AI Bot â€” Stable 24/7 Installer</h2>

<input id="token" placeholder="GitHub PAT (repo + workflow)">
<input id="repo" placeholder="Repository name">
<input id="tg" placeholder="Telegram Bot Token">
<input id="openrouter" placeholder="OpenRouter API Key">

<button onclick="install()">INSTALL</button>

<pre id="log"></pre>

<script>
const logEl=document.getElementById("log");
function log(t){logEl.textContent+=t+"\\n";logEl.scrollTop=logEl.scrollHeight;}
function b64(s){return btoa(unescape(encodeURIComponent(s)));}

async function install(){

const token=document.getElementById("token").value.trim();
const repo=document.getElementById("repo").value.trim();
const tg=document.getElementById("tg").value.trim();
const openrouter=document.getElementById("openrouter").value.trim();

if(!token||!repo||!tg||!openrouter){log("Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ");return;}

const headers={
Authorization:`token ${token}`,
Accept:"application/vnd.github+json",
"Content-Type":"application/json"
};

try{

const userRes=await fetch("https://api.github.com/user",{headers});
if(!userRes.ok) throw new Error("PAT Ð½ÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹");
const user=await userRes.json();
const username=user.login;

await fetch("https://api.github.com/user/repos",{
method:"POST",
headers,
body:JSON.stringify({name:repo,private:false})
});

const repoApi=`https://api.github.com/repos/${username}/${repo}`;

async function upload(path,content){
const url=`${repoApi}/contents/${path}`;
let sha;
const check=await fetch(url,{headers});
if(check.ok){sha=(await check.json()).sha;}
await fetch(url,{
method:"PUT",
headers,
body:JSON.stringify({
message:"auto install "+path,
content:b64(content),
sha
})
});
}

const bot=`
import fetch from "node-fetch";

const TOKEN = process.env.TELEGRAM_TOKEN;
const OPENROUTER = process.env.OPENROUTER_KEY;
const GH_TOKEN = process.env.GITHUB_TOKEN;
const REPO = process.env.GITHUB_REPOSITORY;

let offset=0;
let offsetSha=null;

async function githubGet(path){
const r=await fetch(\`https://api.github.com/repos/\${REPO}/contents/\${path}\`,{
headers:{Authorization:\`token \${GH_TOKEN}\`}
});
return r.json();
}

async function githubPut(path,content,sha,message){
await fetch(\`https://api.github.com/repos/\${REPO}/contents/\${path}\`,{
method:"PUT",
headers:{
Authorization:\`token \${GH_TOKEN}\`,
"Content-Type":"application/json"
},
body:JSON.stringify({
message,
content:Buffer.from(content).toString("base64"),
sha
})
});
}

async function loadOffset(){
const d=await githubGet("offset.json");
offsetSha=d.sha;
offset=JSON.parse(Buffer.from(d.content,"base64").toString()).offset||0;
}

async function saveOffset(){
await githubPut("offset.json",JSON.stringify({offset}),offsetSha,"update offset");
}

async function ai(text){
const r=await fetch("https://openrouter.ai/api/v1/chat/completions",{
method:"POST",
headers:{
Authorization:\`Bearer \${OPENROUTER}\`,
"Content-Type":"application/json"
},
body:JSON.stringify({
model:"openai/gpt-4o-mini",
messages:[{role:"user",content:text}]
})
});
const d=await r.json();
return d.choices?.[0]?.message?.content||"AI error";
}

async function send(id,text){
await fetch(\`https://api.telegram.org/bot\${TOKEN}/sendMessage\`,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({chat_id:id,text})
});
}

async function loop(){
const start=Date.now();
while(true){

if(Date.now()-start>1000*60*340){
console.log("Restarting workflow...");
process.exit(0);
}

const r=await fetch(\`https://api.telegram.org/bot\${TOKEN}/getUpdates?offset=\${offset}\`);
const d=await r.json();

for(const u of d.result){
offset=u.update_id+1;
if(u.message?.text){
const reply=await ai(u.message.text);
await send(u.message.chat.id,reply);
}
}

if(d.result.length>0){
await saveOffset();
}

await new Promise(res=>setTimeout(res,2000));
}
}

await loadOffset();
await loop();
`;

await upload("bot.js",bot);

await upload("package.json",JSON.stringify({
type:"module",
dependencies:{ "node-fetch":"^3.3.2" }
},null,2));

await upload("offset.json",'{"offset":0}');

const workflow=`
name: Stable Runner
on:
schedule:
- cron: "*/5 * * * *"
workflow_dispatch:
jobs:
run:
runs-on: ubuntu-latest
timeout-minutes: 350
steps:
- uses: actions/checkout@v4
- uses: actions/setup-node@v4
with:
node-version: 20
- run: npm install
- run: node bot.js
env:
TELEGRAM_TOKEN: \${{ secrets.TELEGRAM_TOKEN }}
OPENROUTER_KEY: \${{ secrets.OPENROUTER_KEY }}
GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
`;

await upload(".github/workflows/stable.yml",workflow);

const keyRes=await fetch(\`\${repoApi}/actions/secrets/public-key\`,{headers});
const {key,key_id}=await keyRes.json();

function encrypt(val){
const pk=naclUtil.decodeBase64(key);
const msg=naclUtil.decodeUTF8(val);
return naclUtil.encodeBase64(nacl.box.seal(msg,pk));
}

await fetch(\`\${repoApi}/actions/secrets/TELEGRAM_TOKEN\`,{
method:"PUT",
headers,
body:JSON.stringify({encrypted_value:encrypt(tg),key_id})
});

await fetch(\`\${repoApi}/actions/secrets/OPENROUTER_KEY\`,{
method:"PUT",
headers,
body:JSON.stringify({encrypted_value:encrypt(openrouter),key_id})
});

log("âœ… INSTALL COMPLETE");
log("ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸ Ð² GitHub â†’ Actions â†’ Stable Runner â†’ Run workflow");

}catch(e){
log("ÐžÑˆÐ¸Ð±ÐºÐ°: "+e.message);
}
}
</script>
</body>
</html>
