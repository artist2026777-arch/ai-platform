<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Cluster PRO Installer</title>
<style>
body{background:#0f172a;color:white;font-family:Arial;padding:30px}
input{display:block;margin:10px 0;padding:12px;width:450px}
button{padding:12px 25px;background:#22c55e;border:0;color:white;font-weight:bold;cursor:pointer}
pre{background:#111;padding:20px;margin-top:20px;white-space:pre-wrap}
</style>
</head>
<body>

<h1>ðŸ”¥ GitHub AI Cluster PRO</h1>

<input id="token" placeholder="GitHub PAT (repo + workflow)">
<input id="repo" placeholder="Repository Name">
<input id="tg" placeholder="Telegram Bot Token">
<input id="openrouter" placeholder="OpenRouter API Key">

<button onclick="install()">DEPLOY FULL</button>

<pre id="log"></pre>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl-util/0.15.1/nacl-util.min.js"></script>

<script>

function log(t){document.getElementById("log").innerText+=t+"\n"}

async function install(){

const token=document.getElementById("token").value.trim();
const repo=document.getElementById("repo").value.trim();
const tg=document.getElementById("tg").value.trim();
const open=document.getElementById("openrouter").value.trim();

if(!token||!repo||!tg||!open){
log("Fill all fields!");
return;
}

const headers={
"Authorization":"token "+token,
"Accept":"application/vnd.github+json",
"Content-Type":"application/json"
};

log("Creating repository...");

let r=await fetch("https://api.github.com/user/repos",{
method:"POST",
headers,
body:JSON.stringify({name:repo,private:false})
});

if(!r.ok){log("Repo creation failed");return;}

const user=await fetch("https://api.github.com/user",{headers});
const username=(await user.json()).login;

function b64(str){return btoa(unescape(encodeURIComponent(str)))}

async function createFile(path,content){
await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`,{
method:"PUT",
headers,
body:JSON.stringify({
message:"init",
content:b64(content)
})
});
}

log("Uploading files...");

await createFile("cluster/state.json",JSON.stringify({master:"",last_heartbeat:0},null,2));
await createFile("cluster/offset.json",JSON.stringify({offset:0},null,2));

await createFile("package.json",`{
"type":"module",
"dependencies":{"node-fetch":"^3.3.2"}
}`);

await createFile("bot.js",`
import fs from "fs";
import fetch from "node-fetch";
import { execSync } from "child_process";

const node = process.env.NODE_NAME;
const telegram = process.env.TELEGRAM_TOKEN;
const openrouter = process.env.OPENROUTER_KEY;

let state = JSON.parse(fs.readFileSync("cluster/state.json"));
let offsetData = JSON.parse(fs.readFileSync("cluster/offset.json"));

const now = Date.now();
const TIMEOUT = 90000;

if (!state.master || now - state.last_heartbeat > TIMEOUT) {
  state.master = node;
  state.last_heartbeat = now;
}

if (state.master !== node) process.exit(0);

async function getUpdates() {
  const res = await fetch(
    \`https://api.telegram.org/bot\${telegram}/getUpdates?offset=\${offsetData.offset}\`
  );
  return res.json();
}

async function sendMessage(chat, text) {
  await fetch(
    \`https://api.telegram.org/bot\${telegram}/sendMessage\`,
    {method:"POST",
     headers:{"Content-Type":"application/json"},
     body:JSON.stringify({chat_id:chat,text})}
  );
}

async function askAI(text) {
  const res = await fetch("https://openrouter.ai/api/v1/chat/completions",{
    method:"POST",
    headers:{
      "Authorization":"Bearer "+openrouter,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      model:"openai/gpt-4o-mini",
      messages:[{role:"user",content:text}]
    })
  });
  const data=await res.json();
  return data.choices?.[0]?.message?.content||"Error";
}

async function run(){
  const updates=await getUpdates();
  if(!updates.result)return;

  for(const u of updates.result){
    offsetData.offset=u.update_id+1;
    if(u.message?.text){
      const reply=await askAI(u.message.text);
      await sendMessage(u.message.chat.id,reply);
    }
  }

  state.last_heartbeat=Date.now();

  fs.writeFileSync("cluster/state.json",JSON.stringify(state,null,2));
  fs.writeFileSync("cluster/offset.json",JSON.stringify(offsetData,null,2));

  execSync("git config user.name 'cluster'");
  execSync("git config user.email 'cluster@bot'");
  execSync("git add .");
  execSync("git commit -m 'heartbeat'");
  execSync("git push");
}

run();
`);

function workflow(name){
return `
name: ${name}
on:
  schedule:
    - cron: "*/2 * * * *"
  workflow_dispatch:
jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: npm install
      - run: node bot.js
        env:
          NODE_NAME: "${name}"
          TELEGRAM_TOKEN: \${{ secrets.TELEGRAM_TOKEN }}
          OPENROUTER_KEY: \${{ secrets.OPENROUTER_KEY }}
`;
}

await createFile(".github/workflows/node1.yml",workflow("node1"));
await createFile(".github/workflows/node2.yml",workflow("node2"));
await createFile(".github/workflows/node3.yml",workflow("node3"));

log("Adding encrypted secrets...");

const keyRes=await fetch(`https://api.github.com/repos/${username}/${repo}/actions/secrets/public-key`,{headers});
const keyData=await keyRes.json();

function encryptSecret(secret){
const publicKey=naclUtil.decodeBase64(keyData.key);
const secretBytes=naclUtil.decodeUTF8(secret);
const encrypted=nacl.box.seal(secretBytes,publicKey);
return naclUtil.encodeBase64(encrypted);
}

async function setSecret(name,value){
await fetch(`https://api.github.com/repos/${username}/${repo}/actions/secrets/${name}`,{
method:"PUT",
headers,
body:JSON.stringify({
encrypted_value:encryptSecret(value),
key_id:keyData.key_id
})
});
}

await setSecret("TELEGRAM_TOKEN",tg);
await setSecret("OPENROUTER_KEY",open);

log("DEPLOY COMPLETE.");
log("Go to Actions tab and enable workflows.");

}

</script>
</body>
</html>
