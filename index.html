<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ðŸ”¥ PRO MAX GitHub AI Cluster</title>
<style>
body{background:#0f172a;color:white;font-family:Arial;padding:40px}
input{display:block;margin:10px 0;padding:10px;width:420px}
button{padding:12px 25px;background:#22c55e;border:0;color:white;font-weight:bold;cursor:pointer}
pre{background:#111;padding:20px;margin-top:20px;white-space:pre-wrap}
</style>
</head>
<body>

<h1>ðŸ”¥ PRO MAX Cluster Installer</h1>

<input id="token" placeholder="GitHub PAT (repo + workflow)">
<input id="repo" placeholder="Repository Name">
<input id="telegram" placeholder="Telegram Bot Token">
<input id="openrouter" placeholder="OpenRouter API Key">

<button onclick="install()">DEPLOY PRO MAX</button>

<pre id="log"></pre>

<script>
function log(t){document.getElementById("log").innerText+=t+"\\n"}

async function install(){

const token=document.getElementById("token").value;
const repo=document.getElementById("repo").value;

const headers={
"Authorization":"token "+token,
"Accept":"application/vnd.github+json",
"Content-Type":"application/json"
};

await fetch("https://api.github.com/user/repos",{
method:"POST",
headers,
body:JSON.stringify({name:repo,private:false})
});

const user=await fetch("https://api.github.com/user",{headers});
const username=(await user.json()).login;

function b64(str){return btoa(unescape(encodeURIComponent(str)))}

async function createFile(path,content){
await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`,{
method:"PUT",
headers,
body:JSON.stringify({
message:"PRO MAX deploy",
content:b64(content)
})
});
}

await createFile("cluster/state.json",
JSON.stringify({master:"",last_heartbeat:0},null,2));

await createFile("cluster/offset.json",
JSON.stringify({telegram_offset:0},null,2));

await createFile("cluster/lock.json",
JSON.stringify({locked:false,timestamp:0},null,2));

await createFile("bot.js",`
const fs=require('fs');
const {execSync}=require('child_process');

const node=process.env.NODE_NAME;
let state=JSON.parse(fs.readFileSync("cluster/state.json"));
let lock=JSON.parse(fs.readFileSync("cluster/lock.json"));

const now=Date.now();

if(!state.master || now-state.last_heartbeat>90000){
state.master=node;
state.last_heartbeat=now;
}

if(state.master!==node){
console.log("Not master");
process.exit(0);
}

if(lock.locked && now-lock.timestamp<15000){
console.log("Waiting lock...");
process.exit(0);
}

lock.locked=true;
lock.timestamp=now;
fs.writeFileSync("cluster/lock.json",JSON.stringify(lock,null,2));

state.last_heartbeat=Date.now();
fs.writeFileSync("cluster/state.json",JSON.stringify(state,null,2));

execSync("git config user.name 'cluster'");
execSync("git config user.email 'cluster@bot'");
execSync("git add .");
execSync("git commit -m 'heartbeat'");
execSync("git push");

lock.locked=false;
fs.writeFileSync("cluster/lock.json",JSON.stringify(lock,null,2));

console.log("Heartbeat updated");
`);

function nodeWorkflow(name){
return `
name: ${name}

on:
  schedule:
    - cron: "*/4 * * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: node bot.js
        env:
          NODE_NAME: "${name}"
`;
}

await createFile(".github/workflows/node1.yml",nodeWorkflow("node1"));
await createFile(".github/workflows/node2.yml",nodeWorkflow("node2"));
await createFile(".github/workflows/node3.yml",nodeWorkflow("node3"));

await createFile(".github/workflows/watchdog.yml",`
name: watchdog

on:
  schedule:
    - cron: "*/3 * * * *"

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: |
          echo "Watchdog active"
`);

log("PRO MAX deployed.");
}
</script>

</body>
</html>
