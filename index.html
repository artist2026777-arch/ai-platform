<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Конструктор Telegram-ботов с ИИ — Готовый запуск</title>
<style>
  body {
    background: #0f172a;
    color: #e2e8f0;
    font-family: Arial, sans-serif;
    padding: 30px;
    max-width: 920px;
    margin: auto;
    line-height: 1.5;
  }
  h1 { color: #a5b4fc; margin-bottom: 20px; }
  label { display: block; margin: 20px 0 8px; font-weight: bold; }
  input, textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    background: #1e293b;
    color: white;
    border: 1px solid #334155;
    border-radius: 6px;
    font-family: monospace;
    box-sizing: border-box;
  }
  textarea { height: 220px; resize: vertical; }
  button {
    padding: 16px 40px;
    background: #22c55e;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 17px;
    font-weight: bold;
    cursor: pointer;
    margin: 10px 5px 20px 0;
  }
  button:hover { background: #16a34a; }
  #status {
    padding: 16px;
    border-radius: 8px;
    margin: 20px 0;
    font-weight: bold;
  }
  .success { background: #16a34a; color: white; }
  .error   { background: #dc2626; color: white; }
  pre {
    background: #111;
    padding: 20px;
    border-radius: 8px;
    white-space: pre-wrap;
    max-height: 600px;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.4;
  }
</style>
</head>
<body>

<h1>Конструктор Telegram-ботов с ИИ — Твои ключи уже внутри</h1>

<label>GitHub PAT</label>
<input id="token" value="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">

<label>Имя репозитория</label>
<input id="repo" value="mu-bot-ai">

<label>Telegram Bot Token (вставь свой)</label>
<input id="tg" placeholder="123456:AAE...">

<label>OpenRouter API Key</label>
<input id="openrouter" value="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">

<label>Опиши бота (чем подробнее — тем лучше)</label>
<textarea id="description">Создай Telegram-бота для услуг клининга в Уфе.  
Функции:  
- /start — приветствие + главное меню с кнопками: "Цены", "Записаться", "Контакты", "Отзывы"  
- "Цены" — показывает список услуг и цены (например: уборка квартиры от 2500 руб.)  
- "Записаться" — спрашивает адрес, дату, телефон  
- "Контакты" — показывает телефон +79191665789, WhatsApp и адрес  
- "Отзывы" — несколько примеров отзывов  
- Все сообщения на русском языке  
- Reply-кнопки и inline-кнопки для удобной навигации  
- Простая обратная связь: если пользователь пишет "Хочу уборку" — бот отвечает и предлагает записаться</textarea>

<div>
  <button onclick="checkPat()">ПРОВЕРИТЬ PAT</button>
  <button onclick="generateAndDeploy()">СОЗДАТЬ И ЗАПУСТИТЬ БОТА</button>
</div>

<div id="status"></div>
<pre id="log">Логи появятся здесь...\n</pre>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl-util/0.15.1/nacl-util.min.js"></script>

<script>
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');

function log(text) {
  logEl.textContent += text + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(text, type = '') {
  statusEl.textContent = text;
  statusEl.className = 'status ' + type;
}

async function checkPat() {
  const token = document.getElementById('token').value.trim();
  if (!token) return setStatus('PAT пустой', 'error');

  setStatus('Проверяю PAT...', '');
  log('→ Проверка PAT');

  try {
    const res = await fetch('https://api.github.com/user', {
      headers: {
        Authorization: `token ${token}`,
        Accept: 'application/vnd.github+json'
      }
    });

    if (!res.ok) {
      const err = await res.text();
      throw new Error(`GitHub ответил ${res.status}: ${err}`);
    }

    const user = await res.json();
    log(`→ PAT работает! Ты: ${user.login}`);
    setStatus(`PAT валиден. Пользователь: ${user.login}`, 'success');
  } catch (err) {
    log('Ошибка PAT: ' + err.message);
    setStatus('PAT не работает: ' + err.message, 'error');
  }
}

async function generateBotFiles(description, apiKey) {
  setStatus('Генерирую код через OpenRouter...', '');
  log('→ Запрос к OpenRouter');

  const prompt = `
Ты — эксперт по Telegram-ботам на Node.js (long polling).

Создай полный набор файлов по описанию:

"${description}"

Требования:
- bot.js — long polling (getUpdates, timeout=55)
- node-fetch для Telegram и OpenRouter
- Состояние в JSON-файлах
- git commit & push после изменений
- reply и inline кнопки, обработка callback_query
- команды (/start и др.)
- try/catch, reconnect
- Для GitHub Actions (6 ч max)

Ответ ТОЛЬКО в формате:

--- bot.js ---
код

--- package.json ---
json

--- offset.json ---
json

и т.д.
Без лишнего текста!
`;

  try {
    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'openai/gpt-4o-mini',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 4500,
        temperature: 0.35
      })
    });

    if (!res.ok) throw new Error(`OpenRouter ${res.status}`);

    const data = await res.json();
    const text = data.choices?.[0]?.message?.content || '';

    const files = {};
    const blocks = text.split(/---\s*([\w\-.]+)\s*---/g);
    for (let i = 1; i < blocks.length; i += 2) {
      const name = blocks[i].trim();
      const code = blocks[i + 1]?.trim() || '';
      if (name && code) files[name] = code;
    }

    if (!files['bot.js']) throw new Error('bot.js не найден в ответе ИИ');

    log(`Файлы получены: ${Object.keys(files).join(', ')}`);
    return files;
  } catch (err) {
    throw err;
  }
}

async function deploy() {
  const token      = document.getElementById('token').value.trim();
  const repo       = document.getElementById('repo').value.trim();
  const tg         = document.getElementById('tg').value.trim();
  const openrouter = document.getElementById('openrouter').value.trim();
  const desc       = document.getElementById('description').value.trim();

  if (!token || !repo || !tg || !openrouter || !desc) {
    setStatus('Заполни все поля!', 'error');
    return;
  }

  log('Запуск деплоя...');

  try {
    const files = await generateBotFiles(desc, openrouter);

    const headers = {
      Authorization: `token ${token}`,
      Accept: 'application/vnd.github+json',
      'Content-Type': 'application/json'
    };

    const userRes = await fetch('https://api.github.com/user', { headers });
    if (!userRes.ok) throw new Error('PAT недействителен');
    const { login: username } = await userRes.json();
    log(`→ Аккаунт: ${username}`);

    await fetch('https://api.github.com/user/repos', {
      method: 'POST',
      headers,
      body: JSON.stringify({ name: repo, private: false })
    }).catch(() => log('Репозиторий уже есть'));

    log(`→ Репозиторий: \( {username}/ \){repo}`);

    async function uploadFile(path, content, msg = 'AI generated') {
      const url = `https://api.github.com/repos/\( {username}/ \){repo}/contents/${path}`;
      let sha;
      try {
        const r = await fetch(url, { headers });
        if (r.ok) ({ sha } = await r.json());
      } catch {}
      const res = await fetch(url, {
        method: 'PUT',
        headers,
        body: JSON.stringify({
          message: msg,
          content: btoa(unescape(encodeURIComponent(content))),
          sha
        })
      });
      if (!res.ok) throw new Error(`Загрузка ${path} провалилась: ${res.status}`);
      log(`✓ ${path}`);
    }

    for (const [name, content] of Object.entries(files)) {
      await uploadFile(name, content);
    }

    // workflow
    const wf = `
name: AI Bot
on:
  schedule: [cron: '0 */5 * * *']
  workflow_dispatch:
jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: {node-version: 20}
      - run: npm install
      - run: node bot.js
        env:
          TELEGRAM_TOKEN: \${{ secrets.TELEGRAM_TOKEN }}
          OPENROUTER_KEY: \${{ secrets.OPENROUTER_KEY }}
`.trim();
    await uploadFile('.github/workflows/bot.yml', wf, 'Add workflow');

    // secrets
    const keyRes = await fetch(`https://api.github.com/repos/\( {username}/ \){repo}/actions/secrets/public-key`, { headers });
    const { key, key_id } = await keyRes.json();

    function encrypt(val) {
      const pk = naclUtil.decodeBase64(key);
      const sb = naclUtil.decodeUTF8(val);
      return naclUtil.encodeBase64(nacl.box.seal(sb, pk));
    }

    async function setSecret(name, val) {
      await fetch(`https://api.github.com/repos/\( {username}/ \){repo}/actions/secrets/${name}`, {
        method: 'PUT',
        headers,
        body: JSON.stringify({ encrypted_value: encrypt(val), key_id })
      });
      log(`✓ Секрет ${name}`);
    }

    await setSecret('TELEGRAM_TOKEN', tg);
    await setSecret('OPENROUTER_KEY', openrouter);

    setStatus('Успех! Бот загружен в GitHub. Запусти workflow вручную.', 'success');
    log('Готово! → Actions → Run workflow');
  } catch (err) {
    setStatus('Ошибка: ' + err.message, 'error');
    log('ОШИБКА: ' + err.message);
    console.error(err);
  }
}
</script>
</body>
</html>
